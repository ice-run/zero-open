FROM registry.cn-beijing.aliyuncs.com/daodao-bot/graalvm-maven:25 AS builder
ARG APPLICATION
WORKDIR /build
COPY . .
RUN mkdir -p /root/.m2
RUN echo '<settings><mirrors><mirror><id>aliyun</id><mirrorOf>central</mirrorOf><url>https://maven.aliyun.com/repository/central</url></mirror></mirrors></settings>' > /root/.m2/settings.xml
RUN mvn clean install -Dmaven.test.skip=true -U -e -B -N
RUN mvn clean install -Dmaven.test.skip=true -U -e -B -f dependencies/pom.xml
RUN mvn clean install -Dmaven.test.skip=true -U -e -B -f parent/pom.xml
RUN mvn clean install -Dmaven.test.skip=true -U -e -B -f common/pom.xml
RUN mvn clean install -Dmaven.test.skip=true -U -e -B -f api/pom.xml
RUN mvn -Pnative native:compile -Dmaven.test.skip=true -U -e -B -f service/${APPLICATION}/pom.xml

FROM registry.cn-beijing.aliyuncs.com/daodao-bot/debian.curl:latest
ARG APPLICATION
COPY --from=builder /build/service/${APPLICATION}/target/${APPLICATION} /app
VOLUME /tmp
EXPOSE 80
ENTRYPOINT ["/app"]
